/**
 * Composable pour la gestion des missions avec Strapi
 * Gestion directe de la collection missions via l'API Admin Strapi
 */
import { ref, computed, readonly } from 'vue'

export default async function useMissions() {
  // Configuration Nuxt
  const config = useRuntimeConfig()
  const strapiBaseUrl = config.public.strapi?.url || 'http://localhost:1337/api'

  // √âtats r√©actifs
  const missions = ref([])
  const loading = ref(false)
  const error = ref(null)

  // Computed properties pour les statistiques
  const totalMissions = computed(() => missions.value.length)
  
  const publishedMissions = computed(() => 
    missions.value.filter(mission => mission.status === 'published').length
  )
  
  const draftMissions = computed(() => 
    missions.value.filter(mission => mission.status === 'draft').length
  )
  
  const modifiedMissions = computed(() => 
    missions.value.filter(mission => mission.status === 'modified').length
  )

  /**
   * R√©cup√©rer toutes les missions depuis Strapi
   */
  const fetchMissions = async () => {
    loading.value = true
    error.value = null
    try {
      const { strapiAdminApi } = await import('../service/ApiService.js')
      console.log('üîÑ R√©cup√©ration des missions depuis Strapi...')
      // R√©cup√©rer les missions directement depuis la collection mission (API admin)
      const response = await strapiAdminApi.get('/content-manager/collection-types/api::mission.mission?page=1&pageSize=100')
      if (response && response.results) {
        console.log('üîç DEBUG - R√©ponse Strapi brute (premi√®re mission):', response.results[0])
        console.log('üîç DEBUG - publishedAt:', response.results[0]?.publishedAt)
        console.log('üîç DEBUG - updatedAt:', response.results[0]?.updatedAt)
        console.log('üîç DEBUG - publishedAt type:', typeof response.results[0]?.publishedAt)
        missions.value = response.results.map(mission => {
          const hasPublishedAt = mission.publishedAt != null && mission.publishedAt !== ''
          const publishedDate = hasPublishedAt ? new Date(mission.publishedAt) : null
          const updatedDate = mission.updatedAt ? new Date(mission.updatedAt) : null
          const timeDiffSeconds = publishedDate && updatedDate 
            ? (updatedDate.getTime() - publishedDate.getTime()) / 1000 
            : 0
          const isModified = timeDiffSeconds > 1
          console.log(`üìã Mission "${mission.title}":`, {
            publishedAt: mission.publishedAt,
            updatedAt: mission.updatedAt,
            hasPublishedAt,
            publishedDate: publishedDate?.toISOString(),
            updatedDate: updatedDate?.toISOString(),
            timeDiffSeconds: timeDiffSeconds.toFixed(2),
            isModified,
            calculatedStatus: !hasPublishedAt ? 'draft' : (isModified ? 'modified' : 'published')
          })
          return {
            // Identifiants
            id: mission.id,
            documentId: mission.documentId,
            // Champs requis du schema
            title: mission.title || mission.name || 'Mission sans titre',
            description: mission.description || '',
            latitude: mission.latitude || null,
            longitude: mission.longitude || null,
            threshold: mission.threshold || null,
            // Champs optionnels du schema
            hint: mission.hint || null,
            media: mission.media || null,
            achievement: mission.achievement || null,
            circuit: mission.circuit || null,
            // Champs legacy (pour compatibilit√©)
            address: mission.address || '',
            type: mission.type || 'exploration',
            difficulty: mission.difficulty || 'moyen',
            instructions: mission.instructions || '',
            // M√©tadonn√©es
            published: hasPublishedAt,
            publishedAt: mission.publishedAt,
            createdAt: mission.createdAt,
            updatedAt: mission.updatedAt,
            // Calculer le statut Strapi v5 avec tol√©rance d'1 seconde
            status: !hasPublishedAt ? 'draft' : (isModified ? 'modified' : 'published')
          }
        })
        console.log(`‚úÖ ${missions.value.length} missions r√©cup√©r√©es avec succ√®s`)
        console.log('üîç Structure d\'une mission:', missions.value[0])
      } else {
        console.warn('‚ö†Ô∏è Structure de r√©ponse inattendue:', response)
        missions.value = []
      }
      error.value = null
    } catch (err) {
      console.error('‚ùå Erreur lors de la r√©cup√©ration des missions:', err)
      error.value = `Erreur de connexion √† Strapi: ${err.message}`
      // Message d'aide pour le d√©veloppement
      if (err.message.includes('ERR_CONNECTION_REFUSED')) {
        error.value = 'Impossible de se connecter √† Strapi. V√©rifiez que Strapi est d√©marr√© sur localhost:1337'
      } else if (err.message.includes('404')) {
        error.value = 'Route missions non trouv√©e. V√©rifiez la configuration de Strapi'
      } else if (err.message.includes('403')) {
        error.value = 'Acc√®s refus√©. Vous devez √™tre connect√© en tant qu\'administrateur Strapi'
      } else if (err.message.includes('401')) {
        error.value = 'Token d\'authentification manquant ou expir√©. Reconnectez-vous √† l\'administration'
      }
      missions.value = []
    } finally {
      loading.value = false
    }
  }

  /**
   * R√©cup√©rer une mission par son ID (documentId)
   */
  const fetchMissionById = async (missionId) => {
    try {
      const { strapiAdminApi } = await import('../service/ApiService.js')
      // Utiliser documentId pour les op√©rations individuelles
      const response = await strapiAdminApi.get(`/content-manager/collection-types/api::mission.mission/${missionId}`)
      
      return response.data || response
    } catch (err) {
      console.error(`Erreur lors de la r√©cup√©ration de la mission ${missionId}:`, err)
      throw new Error(`Impossible de r√©cup√©rer la mission: ${err.message}`)
    }
  }

  /**
   * Cr√©er une nouvelle mission
   */
  /**
   * Cr√©er une nouvelle mission (en cr√©ant un nouveau circuit)
   */
  const createMission = async (missionData) => {
    try {
      const { strapiAdminApi } = await import('../service/ApiService.js')
      
      console.log('üîÑ Cr√©ation d\'un nouveau circuit avec mission...')
      
      // Cr√©er un circuit avec la mission comme composant
      const circuitData = {
        name: missionData.title || 'Circuit sans nom',
        description: missionData.description || '',
        duration: 60, // Dur√©e par d√©faut en minutes
        like: 0,
        Missions: [{
          title: missionData.title,
          description: missionData.description,
          latitude: missionData.latitude,
          longitude: missionData.longitude,
          threshold: missionData.threshold,
          hint: missionData.hint || null,
          media: missionData.media || null,
          achievement: missionData.achievement || null,
          // Legacy fields
          type: missionData.type || 'exploration',
          difficulty: missionData.difficulty || 'moyen',
          instructions: missionData.instructions || ''
        }],
        address: missionData.address ? {
          street: missionData.address,
          latitude: missionData.latitude,
          longitude: missionData.longitude
        } : null
      }
      
      const response = await strapiAdminApi.post('/content-manager/collection-types/api::circuit.circuit', circuitData)
      
      // Recharger toutes les missions pour refl√©ter les changements
      await fetchMissions()
      
      console.log('‚úÖ Nouveau circuit avec mission cr√©√© avec succ√®s')
      return response
      
    } catch (err) {
      console.error('‚ùå Erreur lors de la cr√©ation du circuit/mission:', err)
      error.value = `Impossible de cr√©er la mission: ${err.message}`
      throw err
    }
  }

  /**
   * Mettre √† jour une mission
   */
  const updateMission = async (missionId, missionData) => {
    try {
      console.log('üîç useMissions - updateMission appel√© avec:', {
        missionId,
        missionData,
        url: `/content-manager/collection-types/api::mission.mission/${missionId}`
      })
      
      const { strapiAdminApi } = await import('../service/ApiService.js')
      
      // IMPORTANT : Strapi Content Manager API attend les donn√©es dans un objet { data: {...} }
      const payload = missionData
      
      console.log('üì¶ useMissions - Payload envoy√©:', payload)
      
      // Utiliser documentId pour les op√©rations individuelles
      const response = await strapiAdminApi.put(`/content-manager/collection-types/api::mission.mission/${missionId}`, payload)
      
      console.log('üì° useMissions - R√©ponse de Strapi:', response)
      
      // Mettre √† jour dans la liste locale en utilisant documentId
      const index = missions.value.findIndex(mission => mission.documentId === missionId || mission.id === missionId)
      console.log('üîé useMissions - Index trouv√© dans la liste locale:', index)
      
      if (index !== -1) {
        // Fusionner les nouvelles donn√©es avec l'objet existant pour garder tous les champs
        missions.value[index] = { ...missions.value[index], ...(response.data || response) }
        console.log('‚úÖ useMissions - Mission mise √† jour dans la liste locale:', missions.value[index])
      } else {
        console.warn('‚ö†Ô∏è useMissions - Mission non trouv√©e dans la liste locale')
      }
      
      console.log(`‚úÖ Mission ${missionId} mise √† jour avec succ√®s`)
      return response.data || response
      
    } catch (err) {
      console.error(`‚ùå useMissions - Erreur lors de la mise √† jour de la mission ${missionId}:`, {
        message: err.message,
        response: err.response,
        status: err.response?.status,
        data: err.response?.data
      })
      error.value = `Impossible de mettre √† jour la mission: ${err.message}`
      throw err
    }
  }

  /**
   * Supprimer une mission
   */
  const deleteMission = async (missionId) => {
    try {
      const { strapiAdminApi } = await import('../service/ApiService.js')
      
      // Utiliser documentId pour les op√©rations individuelles  
      await strapiAdminApi.delete(`/content-manager/collection-types/api::mission.mission/${missionId}`)
      
      // Mettre √† jour la liste locale en utilisant documentId ou id
      missions.value = missions.value.filter(mission => mission.documentId !== missionId && mission.id !== missionId)
      
      console.log(`‚úÖ Mission ${missionId} supprim√©e avec succ√®s`)
      error.value = null
      return true
      
    } catch (err) {
      console.error(`‚ùå Erreur lors de la suppression de la mission ${missionId}:`, err)
      
      // Enhanced error handling for authentication and permission issues
      if (err.message.includes('401')) {
        throw new Error('Session expir√©e. Veuillez vous reconnecter.')
      } else if (err.message.includes('403')) {
        throw new Error('Permissions insuffisantes pour supprimer cette mission.')
      } else if (err.message.includes('404')) {
        throw new Error('Mission non trouv√©e.')
      } else {
        throw new Error('Erreur lors de la suppression de la mission. Veuillez r√©essayer.')
      }
    }
  }

  /**
   * Publier une mission (Strapi v5 Draft & Publish)
   */
  const publishMission = async (missionId) => {
    try {
      const { strapiAdminApi } = await import('../service/ApiService.js')
      
      console.log(`üì¢ Publication de la mission ${missionId}...`)
      
      // Endpoint Strapi v5 pour publier
      const response = await strapiAdminApi.post(`/content-manager/collection-types/api::mission.mission/${missionId}/actions/publish`, {})
      
      console.log(`‚úÖ Mission ${missionId} publi√©e avec succ√®s`)
      
      // Mettre √† jour dans la liste locale
      const index = missions.value.findIndex(mission => mission.documentId === missionId || mission.id === missionId)
      if (index !== -1) {
        missions.value[index].publishedAt = new Date().toISOString()
        missions.value[index].published = true
      }
      
      return response.data || response
      
    } catch (err) {
      console.error(`‚ùå Erreur lors de la publication de la mission ${missionId}:`, err)
      error.value = `Impossible de publier la mission: ${err.message}`
      throw err
    }
  }

  /**
   * D√©publier une mission (Strapi v5 Draft & Publish)
   */
  const unpublishMission = async (missionId) => {
    try {
      const { strapiAdminApi } = await import('../service/ApiService.js')
      
      console.log(`üìù D√©publication de la mission ${missionId}...`)
      
      // Endpoint Strapi v5 pour d√©publier
      const response = await strapiAdminApi.post(`/content-manager/collection-types/api::mission.mission/${missionId}/actions/unpublish`, {})
      
      console.log(`‚úÖ Mission ${missionId} d√©publi√©e avec succ√®s`)
      
      // Mettre √† jour dans la liste locale
      const index = missions.value.findIndex(mission => mission.documentId === missionId || mission.id === missionId)
      if (index !== -1) {
        missions.value[index].publishedAt = null
        missions.value[index].published = false
      }
      
      return response.data || response
      
    } catch (err) {
      console.error(`‚ùå Erreur lors de la d√©publication de la mission ${missionId}:`, err)
      error.value = `Impossible de d√©publier la mission: ${err.message}`
      throw err
    }
  }

  /**
   * Rechercher des missions par titre
   */
  const searchMissions = async (searchTerm) => {
    if (!searchTerm || searchTerm.trim() === '') {
      return missions.value
    }
    
    return missions.value.filter(mission => 
      mission.title && mission.title.toLowerCase().includes(searchTerm.toLowerCase())
    )
  }

  /**
   * Test de connexion √† Strapi (√† supprimer en production)
   */
  const testConnection = async () => {
    try {
      const response = await fetch(`${strapiBaseUrl}/missions`)
      console.log('üîß Test de connexion Strapi:', response.status)
      return response.ok
    } catch (err) {
      console.error('üîß Erreur de connexion Strapi:', err)
      return false
    }
  }

  /**
   * Publier/D√©publier une mission
   */
  const toggleMissionStatus = async (missionId, published) => {
    try {
      // Utiliser publishedAt au lieu de published (structure Strapi)
      const publishedAt = published ? new Date().toISOString() : null
      const updatedMission = await updateMission(missionId, { publishedAt })
      console.log(`‚úÖ Mission ${published ? 'publi√©e' : 'd√©publi√©e'} avec succ√®s`)
      return updatedMission
    } catch (err) {
      console.error('‚ùå Erreur lors du changement de statut:', err)
      throw err
    }
  }

  // M√©thodes utilitaires pour l'affichage
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A'
    try {
      return new Date(dateString).toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    } catch {
      return 'Date invalide'
    }
  }

  const formatCoordinates = (lat, lng) => {
    if (!lat || !lng) return 'N/A'
    return `${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`
  }

  // Helper pour convertir publishedAt en boolean
  const isPublished = (mission) => {
    return mission?.publishedAt != null
  }

  // Helper pour d√©terminer le statut Strapi v5 (draft, published, modified)
  const getMissionStatus = (mission) => {
    if (!mission.publishedAt) {
      return 'draft' // Brouillon
    }
    
    // Comparer les dates pour d√©tecter les modifications
    const publishedDate = new Date(mission.publishedAt)
    const updatedDate = new Date(mission.updatedAt)
    
    // Si updatedAt > publishedAt, il y a des modifications non publi√©es
    if (updatedDate > publishedDate) {
      return 'modified' // Publi√© avec modifications
    }
    
    return 'published' // Publi√©
  }

  // Helper pour ajouter une propri√©t√© published calcul√©e
  const addPublishedProperty = (mission) => {
    return {
      ...mission,
      published: isPublished(mission),
      status: getMissionStatus(mission)
    }
  }

  // Retourner l'API publique
  return {
    // √âtats (readonly pour √©viter les mutations directes)
    missions: readonly(missions),
    loading: readonly(loading),
    error: readonly(error),
    
    // Computed properties
    totalMissions,
    publishedMissions,
    draftMissions,
    modifiedMissions,
    
    // Actions
    fetchMissions,
    fetchMissionById,
    createMission,
    updateMission,
    deleteMission,
    publishMission,
    unpublishMission,
    searchMissions,
    testConnection,
    toggleMissionStatus,
    
    // Utilitaires
    formatDate,
    formatCoordinates,
    isPublished,
    getMissionStatus,
    addPublishedProperty
  }
}